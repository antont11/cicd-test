# This is a basic workflow to help you get started with Actions

name: DC1 CI/CD for production environment

# Controls when the workflow will run
on:
  # Triggers the workflow on push or pull request events but only for the develop branch
  push:
    branches: [ main ]
  workflow_dispatch:


# DC1 workflow for building, testing and scanning the DC1 Project
jobs:

  # This workflow is about building the application
  build:
    # The type of runner that the job will run on
    runs-on: self-hosted

    # Set Java
    env:
      JAVA_HOME: /app/onestopd/jdk

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - uses: actions/checkout@v3

      # Build the project
      - name: Build the project
        run: ./gradlew clean build -x test

  copy-jar:
    needs: build

    # The type of runner that the job will run on
    runs-on: self-hosted

    # Set Deploy directory
    env:
      DEPLOY_DIR: /app/onestopd/onestopshopv2/cicd-runner

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      # Copy Jar
      - name: Copy Jar
        run: cp build/libs/demo-0.0.1-SNAPSHOT.jar $DEPLOY_DIR/demo-0.0.1-SNAPSHOT_new.jar

  deploy:
    needs: copy-jar

    # The type of runner that the job will run on
    runs-on: self-hosted

    # Set Deploy directory
    env:
      DEPLOY_DIR: /app/onestopd/onestopshopv2/cicd-runner

    defaults:
      # Change directory
      run:
        working-directory: /app/onestopd/onestopshopv2/cicd-runner

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:

      # Delete backup
      - name: Delete backup
        run: |
          if [ test -f demo-0.0.1-SNAPSHOT_bk.jar]; then
            rm demo-0.0.1-SNAPSHOT_bk.jar
          else
            echo "file doesn't exist"
          fi

      # Rename old jar
      - name: Rename old jar
        run: |
          if [ test -f demo-0.0.1-SNAPSHOT.jar]; then
            mv demo-0.0.1-SNAPSHOT.jar demo-0.0.1-SNAPSHOT_bk.jar
          else
            echo "file doesn't exist"
          fi

      # Rename new jar
      - name: Rename new jar
        run: |
          if [ test -f demo-0.0.1-SNAPSHOT_new.jar]; then
            mv demo-0.0.1-SNAPSHOT_new.jar demo-0.0.1-SNAPSHOT.jar
          else
            echo "file doesn't exist"
          fi

      # Run jar
      - name: Run new jar
        run: |
          if [ test -f demo-0.0.1-SNAPSHOT.jar]; then
            ./iamservices.sh restart demo-0.0.1-SNAPSHOT.jar
          else
            echo "file doesn't exist"
          fi


